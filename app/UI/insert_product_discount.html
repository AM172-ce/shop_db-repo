<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product Discount</title>
</head>
<body>
    <h1>Add Product Discount</h1>
    <form action="/api/insert_product_discount" method="post" id="productDiscountForm">
        <label for="product_code">Product Code:</label>
        <input type="text" id="product_code" name="product_code" required><br><br>
        
        <label for="discount_value">Discount Value:</label>
        <input type="number" id="discount_value" name="discount_value" required><br><br>
        
        <label for="discount_unit">Discount Unit:</label>
        <select id="discount_unit" name="discount_unit" required>
            <option value="P">Percentage</option>
            <option value="A">Amount</option>
        </select><br><br>
        
        <label for="valid_until">Valid Until:</label>
        <input type="date" id="valid_until" name="valid_until"><br><br>
        
        <label for="discount_description">Discount Description:</label><br>
        <textarea id="discount_description" name="discount_description" rows="4" cols="50"></textarea><br><br>

        {% if message %}
        <p>{{ message }}</p>
        {% endif %}
        
        {% if action == "deactivate" %}
        <label for="deactivate_discount">An active discount record already exists. Deactivate the old one?</label><br>
        <input type="radio" id="yes" name="deactivate_discount" value="yes">
        <label for="yes">Yes</label><br>
        <input type="radio" id="no" name="deactivate_discount" value="no">
        <label for="no">No</label><br><br>
        {% endif %}

        <input type="submit" value="Submit">
    </form>

    <script>
        window.onload = function() {
            var form = document.getElementById('productDiscountForm');
            var existingActiveDiscount = {{ existing_active_discount | tojson }};

            if (existingActiveDiscount) {
                var actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'deactivate';
                form.appendChild(actionInput);
            }

            form.addEventListener('submit', function(event) {
                var deactivateRadio = document.querySelector('input[name="deactivate_discount"]:checked');
                if (deactivateRadio && deactivateRadio.value === 'yes') {
                    // Prevent the default form submission behavior
                    event.preventDefault();

                    // Submit the form with the action set to 'deactivate'
                    var formData = new FormData(form);
                    formData.append('action', 'deactivate');
                    fetch(form.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        // Handle the successful response, if needed
                        return response.text();
                    })
                    .then(data => {
                        // Handle the data from the response, if needed
                        console.log(data);
                        // Reload the page or show a success message, etc.
                    })
                    .catch(error => {
                        // Handle errors
                        console.error('There was a problem with the fetch operation:', error);
                    });
                }
            });
        };
    </script>
</body>
</html>
